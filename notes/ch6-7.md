## æ´»åŠ¨è®°å½•ã€ç¿»è¯‘æˆä¸­é—´ä»£ç 

### ä¸€äº›é—®é¢˜

#### æå‰é€€å‡ºè¿˜æ˜¯ç»§ç»­æ‰§è¡Œ

è¿˜æ˜¯å½“å‘çŽ°è¯­ä¹‰é”™è¯¯æ—¶ï¼Œæ˜¯ç›´æŽ¥é€€å‡ºï¼Œè¿˜æ˜¯ç»™ä¸ªé»˜è®¤å€¼ï¼ˆ`exp` ç»™`Tr_nop()`, `ty` ç»™`Ty_Int()` or `Ty_Void()`ï¼‰ï¼Œ
åŽä¸€ç§çš„æ›´å¤§çš„é—®é¢˜æ˜¯å‡ºçŽ°å„ç§æ®µé”™è¯¯ã€å’Œnull æŒ‡é’ˆé—®é¢˜ã€‚æˆ‘çŽ°åœ¨æ˜¯åªä¸ºäº†è¿‡`testcases` ï¼Œè¿™ä¸¤ç§æ··ç€æ¥ã€‚

#### nil çš„å¤„ç†

ä¸çŸ¥é“æ€Žä¹ˆå¤„ç†

#### æ¡ä»¶è¡¨è¾¾å¼

è¿™ä¸ªæœ€éº»çƒ¦äº†ï¼Œè¿™ä¸ªå‡½æ•°`Tr_ifExp` æˆ‘å†™äº†100 å¤šè¡Œã€‚
éœ€è¦è€ƒè™‘å¤šç§æƒ…å†µ

å¯¹äºŽ

```
if e1 then e2
```

åˆ™`unNx(e2)` ï¼Œä½†æ˜¯å¯¹äºŽ`e2` æ˜¯æ— è¿”å›žå€¼çš„å‡½æ•°ï¼Œå…¶å®žè¿™æ ·è¿˜æ˜¯è¿›è¡Œäº†ç±»åž‹è½¬æ¢

å¯¹äºŽ

```
if e1 then e2 else e3
```

1. æ­£å¸¸æƒ…å†µï¼Œ`if a > b then 1 else 0`ï¼Œ`unEx(e2)` `unEx(e3)` å³å¯
2. æ¥è‡ªâ€œå¹¶â€ å’Œâ€œäº¤â€ çš„æ·å¾„è®¡ç®—ï¼Œ`if a > b then c > 5 else 0` åˆ™éœ€è¦åƒä¹¦ä¸Šé‚£æ ·è½¬æ¢
3. å˜æ€çš„æƒ…å†µï¼Œ`if a > b then a > 5 else b < 3` ï¼Œæˆ‘æ˜¯åœ¨2. çš„åŸºç¡€ä¸Šï¼Œç›´æŽ¥æŠŠ**å¯èƒ½** ä¸æ˜¯æ¯”è¾ƒæ“ä½œçš„è¡¨è¾¾å¼`unEx` äº†ã€‚
4. éƒ½æ˜¯â€œè¯­å¥â€ çš„æƒ…å†µï¼Œ`unNx(e2)` `unNx(e3)` å³å¯
5. è¿”å›žå‡½æ•°çš„æƒ…å†µï¼Œ`if e1 then func() else e3`ï¼Œè¿™ç§æƒ…å†µä¸‹å‡½æ•°æœ‰è¿”å›žå€¼ï¼Œåˆ™ä¸€åˆ‡æ­£å¸¸ã€‚
    ä½†æ²¡æœ‰è¿”å›žå€¼çš„è¯ï¼Œå‡½æ•°ä¾ç„¶æ˜¯ä¸ª`Tr_Ex` ç±»åž‹ï¼Œè€Œ`e3` éœ€è¦å½“`Tr_Nx` å¤„ç†ã€‚
    è¿™ä¸ªæˆ‘æ²¡æœ‰ç‰¹æ®Šå¤„ç†ï¼Œè€Œæ˜¯å½“1. çš„æƒ…å†µå¤„ç†çš„ï¼Œè¿™æ ·ä¹Ÿé—´æŽ¥è¿›è¡Œäº†ç±»åž‹è½¬æ¢ã€‚


### å‡½æ•°å®šä¹‰æ±‡ç¼–

è¿™ä¸¤ç« å¼€å§‹éœ€è¦æŽŒæ¡ä¸€äº›åŸºæœ¬çš„æ±‡ç¼–çŸ¥è¯†ã€‚ 
*è½¯ä»¶å·¥ç¨‹* ä¸“ä¸šå¥½åƒä¸æ•™æ±‡ç¼–ï¼Œæˆ‘çš„åŸºæœ¬æ±‡ç¼–çŸ¥è¯†è¿˜æ˜¯æ¥è‡ªã€Šæ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿã€‹çš„ðŸ˜›ã€‚


æŒ‰`7.3.2` çš„å®šä¹‰ï¼Œå‡½æ•°å°†è¢«ç¿»è¯‘æˆç”± **å…¥å£å¤„ç†ä»£ç (prologue)**ã€ **å‡½æ•°ä½“(body)**ã€å’Œ **å‡ºå£å¤„ç†ä»£ç (epilogue)**
ç»„æˆçš„æ±‡ç¼–è¯­è¨€ä»£ç æ®µã€‚

**å…¥å£å¤„ç†ä»£ç ** åŒ…æ‹¬å¦‚ä¸‹éƒ¨åˆ†ã€‚

1. ç‰¹å®šæ±‡ç¼–è¯­è¨€éœ€è¦çš„å£°æ˜Žä¸€ä¸ªå‡½æ•°å¼€å§‹çš„ä¼ªæŒ‡ä»¤ã€‚
2. å‡½æ•°åå­—çš„æ ‡å·å®šä¹‰ã€‚
3. è°ƒæ•´æ ˆæŒ‡é’ˆçš„ä¸€æ¡æŒ‡ä»¤ï¼ˆç”¨ä»¥åˆ†é…ä¸€ä¸ªæ–°æ ˆå¸§ï¼‰ã€‚
4. å°†â€œé€ƒé€¸â€ å‚æ•°ï¼ˆåŒ…æ‹¬é™æ€é“¾ï¼‰ä¿å­˜å€¼æ ˆå¸§çš„æŒ‡ä»¤ï¼Œä»¥åŠå°†éžé€ƒé€¸å‚æ•°ä¼ é€åˆ°æ–°çš„ä¸´æ—¶å¯„å­˜å™¨çš„æŒ‡ä»¤ã€‚
5. ä¿å­˜åœ¨æ­¤å‡½æ•°å†…ç”¨åˆ°çš„è¢«è°ƒç”¨è€…ä¿æŠ¤çš„å¯„å­˜å™¨ï¼ˆåŒ…æ‹¬è¿”å›žåœ°å€å¯„å­˜å™¨ï¼‰çš„å­˜å‚¨æŒ‡ä»¤ã€‚

**å‡½æ•°ä½“(body)**

6. è¯¥å‡½æ•°çš„å‡½æ•°ä½“ã€‚

**å‡ºå£å¤„ç†ä»£ç (epilogue)**

7. å°†è¿”å›žå€¼ï¼ˆå‡½æ•°çš„ç»“æžœï¼‰è¿”å›žè‡³ä¸“ç”¨äºŽè¿”å›žç»“æžœçš„å¯„å­˜å™¨çš„æŒ‡ä»¤ã€‚
8. ç”¨äºŽæ¢å¤è¢«è°ƒç”¨è€…ä¿æŠ¤çš„å¯„å­˜å™¨çš„å–æ•°æŒ‡ä»¤ã€‚
9. æ¢å¤æ ˆæŒ‡é’ˆçš„æŒ‡ä»¤ï¼ˆé‡Šæ”¾æ ˆå¸§ï¼‰ã€‚
10. ä¸€æ¡`return` æŒ‡ä»¤ï¼ˆJUMP åˆ°è¿”å›žåœ°å€ï¼‰ã€‚
11. æ±‡ç¼–è¯­è¨€éœ€è¦çš„å£°æ˜Žä¸€ä¸ªå‡½æ•°ç»“æŸçš„ä¼ªæŒ‡ä»¤ã€‚


### ä¸€ä¸ªä¾‹å­

```c
int g(int a, int b) {
    return a + b;
}

int f(int a, int b) {
    int c = g(a, b);
    return c;
}
```

å°†ä¸Šé¢çš„`c` ä»£ç è½¬æˆæ±‡ç¼–

`gcc -fno-asynchronous-unwind-tables -S test.c`

`-fno-asynchronous-unwind-tables` ç”¨äºŽåŽ»æŽ‰`CFI`[^set no-cfi] ï¼ˆè¿™ä¸ªæˆ‘ä¸å¤ªæ‡‚ï¼‰


æˆ‘çš„ **MAC Aarch64** ä¸Š`clang` çš„æ±‡ç¼–ï¼š 

```
	.globl	_g                          ; S1 -- Begin function g
	.p2align	                        ; S1
_g:                                     ; S2
; %bb.0:
	sub	sp, sp, #16                     ; S3
	str	w0, [sp, #12]                   ; S4
	str	w1, [sp, #8]                    ; S4
	ldr	w8, [sp, #12]                   ; S6
	ldr	w9, [sp, #8]                    ; S6
	add	w0, w8, w9                      ; S6, S7
	add	sp, sp, #16                     ; S9
	ret                                 ; S10
                                        ; S11 -- End function
	.globl	_f                          ; S1 -- Begin function f
	.p2align	                        ; S1
_f:                                     ; S2
; %bb.0:
	sub	sp, sp, #32                     ; S3
	stp	x29, x30, [sp, #16]             ; S3 S5
	add	x29, sp, #16                    ; S3
	stur	w0, [x29, #-4]              ; S4
	str	w1, [sp, #8]                    ; S4
	ldur	w0, [x29, #-4]              ; S6 call g()
	ldr	w1, [sp, #8]                    ; S6
	bl	_g                              ; S6
	str	w0, [sp, #4]                    ; S6
	ldr	w0, [sp, #4]                    ; S7
	ldp	x29, x30, [sp, #16]             ; S8 S9
	add	sp, sp, #32                     ; S9
	ret                                 ; S10
                                        ; S11 -- End function
.subsections_via_symbols
```


å…¬å¸æœåŠ¡å™¨ä¸Š **intel i7** `gcc` çš„æ±‡ç¼–ï¼š

```
.file   "test.c"
     .text
     .globl  g                  # S1
     .type   g, @function       # S1
 g:                             # S2
     pushq   %rbp               # S3
     movq    %rsp, %rbp         # S3
     movl    %edi, -4(%rbp)     # S4
     movl    %esi, -8(%rbp)     # S4
     movl    -8(%rbp), %eax     # S6
     movl    -4(%rbp), %edx     # S6
     addl    %edx, %eax         # S6
     popq    %rbp               # S9
     ret                        # S10
     .size   g, .-g
     .globl  f                  # S1
     .type   f, @function       # S1
 f:                             # S2
     pushq   %rbp               # S5
     movq    %rsp, %rbp         # S5
     subq    $24, %rsp          # S3
     movl    %edi, -20(%rbp)    # S4
     movl    %esi, -24(%rbp)    # S4
     movl    -24(%rbp), %edx    # S6
     movl    -20(%rbp), %eax    # S6
     movl    %edx, %esi         # S6 call g
     movl    %eax, %edi         # S6
     call    g                  # S6
     movl    %eax, -4(%rbp)     # S6
     movl    -4(%rbp), %eax     # S7
     leave                      # S9
     ret                        # S10
     .size   f, .-f
     .ident  "GCC: (GNU) 4.8.5 20150623 (Red Hat 4.8.5-39)"
     .section    .note.GNU-stack,"",@progbits
```

éƒ½æ²¡æœ‰å¼€ä¼˜åŒ–ï¼Œç›¸æ¯”ä¹‹ä¸‹å…¶å®žæ²¡æœ‰å¾ˆå¤§çš„å·®åˆ«ã€‚ä¸è¿‡åŽè€…å¯¹å‡½æ•°`g` è¿›è¡Œäº† **å¶å­è¿‡ç¨‹** çš„å¤„ç†ï¼Œ
æ²¡æœ‰åˆ†é…æ ˆå¸§ã€‚


### å¯è§çš„æ”¹è¿›

- å¤„ç† **å¶å­è¿‡ç¨‹(leaf procedure)**ï¼Œæ„Ÿè§‰è¿™ä¸ªä¼˜åŒ–åº”è¯¥ä¸éš¾ï¼Œç±»ä¼¼å¤„ç† **é€ƒé€¸** å‚æ•°ï¼Œ
    å¯èƒ½èƒ½åœ¨è¯­ä¹‰é˜¶æ®µéåŽ†çš„æ—¶å€™ä¸€èµ·å¤„ç†å¥½ã€‚


### ä¸€äº›å‚è€ƒ

- [CFI-directives](https://sourceware.org/binutils/docs/as/CFI-directives.html)
- [cfi](https://www.imperialviolet.org/2017/01/18/cfi.html)

[^set no-cfi]: [StackOverflow set no-cfi](https://stackoverflow.com/questions/2529185/what-are-cfi-directives-in-gnu-assembler-gas-used-for)


